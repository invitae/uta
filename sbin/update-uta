#!/usr/bin/env bash

# This script updates the specified UTA and SeqRepo using the given NCBI files.
# It produces a postgres dump of the updated UTA database and an updated SeqRepo (updated in place).
# It expects to be run from the root of the uta repository.

set -e

# export environment variables for docker compose file
export NCBI_DIR=$1
export SEQREPO_DIR=$2
export WORKING_DIR=$3
export UTA_VERSION=$4
export SEQREPO_VERSION=$5

if [ -z "$NCBI_DIR" ] || [ -z "$SEQREPO_DIR" ] || [ -z "$WORKING_DIR" ] || [ -z "$UTA_VERSION" ] || [ -z "$SEQREPO_VERSION" ]
then
    echo 'Usage: sbin/update-uta <ncbi_file_dir> <seqrepo_dir> <uta_version> <seqrepo_version>'
    exit 1
else
    echo "Updating UTA and SeqRepo using files from $NCBI_DIR and SeqRepo data in $SEQREPO_DIR"
    echo "Starting from UTA version $UTA_VERSION and SeqRepo version $SEQREPO_VERSION"
fi

if [[ $NCBI_DIR != /* ]] && [[ $NCBI_DIR != .* ]]
then
    echo 'NCBI file directory must start with / or .'
    exit 1
fi

if [[ $SEQREPO_DIR != /* ]] && [[ $SEQREPO_DIR != .* ]]
then
    echo 'SeqRepo data directory must start with / or .'
    exit 1
fi

if [[ $WORKING_DIR != /* ]] && [[ $WORKING_DIR != .* ]]
then
    echo 'Working directory must start with / or .'
    exit 1
fi

docker build -t uta-update .

# docker compose doesn't respect the container name specified in the compose file, so container name is specified here
docker compose run --rm --name uta-update uta-update

# docker compose -f docker-compose.uta.yml down
